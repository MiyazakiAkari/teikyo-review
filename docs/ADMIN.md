# ç®¡ç†è€…æ©Ÿèƒ½ã‚¬ã‚¤ãƒ‰

ã“ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¯ç®¡ç†è€…ãƒ¦ãƒ¼ã‚¶ãƒ¼æ©Ÿèƒ½ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã™ã€‚

## ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

### 1. Supabaseãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ

Supabaseãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‹ã‚‰ä»¥ä¸‹ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ï¼š

1. Supabase Dashboard ã«ã‚¢ã‚¯ã‚»ã‚¹: https://app.supabase.com
2. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é¸æŠ
3. å·¦ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®ã€ŒSQL Editorã€ã‚’é¸æŠ
4. ã€ŒNew Queryã€ã‚’ã‚¯ãƒªãƒƒã‚¯
5. [supabase/migrations/001_add_admin_functionality.sql](../supabase/migrations/001_add_admin_functionality.sql) ã®å†…å®¹ã‚’ã‚³ãƒ”ãƒ¼ï¼†ãƒšãƒ¼ã‚¹ãƒˆ
6. ã€ŒRunã€ã‚’ã‚¯ãƒªãƒƒã‚¯

ã“ã‚Œã§ä»¥ä¸‹ãŒä½œæˆã•ã‚Œã¾ã™ï¼š

- `profiles` ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆ`is_admin` ã‚«ãƒ©ãƒ ä»˜ãï¼‰
- RLSï¼ˆRow Level Securityï¼‰ãƒãƒªã‚·ãƒ¼
- æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼è‡ªå‹•ä½œæˆãƒˆãƒªã‚¬ãƒ¼

### 2. Service Role Key ã®è¨­å®š

`.env.local` ã« `SUPABASE_SERVICE_KEY` ã‚’è¨­å®šã—ã¦ã„ãªã„å ´åˆã¯ä»¥ä¸‹ã‹ã‚‰å–å¾—ï¼š

1. Supabase Dashboard > Settings > API
2. ã€ŒService Role Keyã€ã‚’ã‚³ãƒ”ãƒ¼
3. `.env.local` ã«è¿½åŠ :
   ```
   SUPABASE_SERVICE_KEY=<ã‚³ãƒ”ãƒ¼ã—ãŸã‚­ãƒ¼>
   ```

## ä½¿ç”¨æ–¹æ³•

### å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’è¡¨ç¤º

```bash
npm run admin-list
```

å‡ºåŠ›ä¾‹ï¼š

```
ğŸ“‹ å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
1. ğŸ‘‘ ç®¡ç†è€…  | admin@stu.teikyo-u.ac.jp (2026/2/7)
2.    ãƒ¦ãƒ¼ã‚¶ãƒ¼ | test1@stu.teikyo-u.ac.jp (2026/2/7)
3.    ãƒ¦ãƒ¼ã‚¶ãƒ¼ | test2@stu.teikyo-u.ac.jp (2026/2/7)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
```

### ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ç®¡ç†è€…ã«æ˜‡æ ¼

```bash
npm run admin-promote test1@stu.teikyo-u.ac.jp
```

### ç®¡ç†è€…æ¨©é™ã‚’å–ã‚Šæ¶ˆã—

```bash
npm run admin-revoke test1@stu.teikyo-u.ac.jp
```

## ã‚³ãƒ¼ãƒ‰å†…ã§ã®ä½¿ç”¨

### ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒç®¡ç†è€…ã‹ã©ã†ã‹ã‚’ç¢ºèª

```typescript
import { isUserAdmin } from '@/lib/admin';

export default async function AdminPanel() {
  const admin = await isUserAdmin();

  if (!admin) {
    return <div>ç®¡ç†è€…ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ã§ã™</div>;
  }

  return <div>ç®¡ç†è€…ãƒ‘ãƒãƒ«</div>;
}
```

### ç‰¹å®šã®ãƒ¦ãƒ¼ã‚¶ãƒ¼IDãŒç®¡ç†è€…ã‹ã©ã†ã‹ã‚’ç¢ºèª

```typescript
import { isUserAdminById } from "@/lib/admin";

const isAdmin = await isUserAdminById(userId);
```

### å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å–å¾—

```typescript
import { getAllUsers } from "@/lib/admin";

const users = await getAllUsers();
users.forEach((user) => {
  console.log(`${user.email}: ${user.is_admin ? "ç®¡ç†è€…" : "ãƒ¦ãƒ¼ã‚¶ãƒ¼"}`);
});
```

### ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’æ˜‡æ ¼/é™æ ¼

```typescript
import { promoteUserToAdmin, revokeAdminFromUser } from "@/lib/admin";

// æ˜‡æ ¼
await promoteUserToAdmin(userId);

// æ¨©é™å–ã‚Šæ¶ˆã—
await revokeAdminFromUser(userId);
```

## ç®¡ç†è€…æ©Ÿèƒ½ã®æ§‹æˆ

### ãƒ†ãƒ¼ãƒ–ãƒ«æ§‹é€ 

```sql
profiles ãƒ†ãƒ¼ãƒ–ãƒ«
â”œâ”€â”€ id (UUID) - ãƒ¦ãƒ¼ã‚¶ãƒ¼ID
â”œâ”€â”€ email (text) - ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
â”œâ”€â”€ is_admin (boolean) - ç®¡ç†è€…ãƒ•ãƒ©ã‚°
â”œâ”€â”€ created_at (timestamp) - ä½œæˆæ—¥æ™‚
â””â”€â”€ updated_at (timestamp) - æ›´æ–°æ—¥æ™‚
```

### ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£

- **RLSï¼ˆRow Level Securityï¼‰**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯è‡ªåˆ†ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½
- **ç®¡ç†è€…æ¨©é™**: ç®¡ç†è€…æ“ä½œã¯è‡ªèº«ãŒç®¡ç†è€…ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ã‹ã‚‰å®Ÿè¡Œ
- **Service Role Key**: ç®¡ç†è€…ç®¡ç†ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯ã‚µãƒ¼ãƒãƒ¼ã‚­ãƒ¼ã‚’ä½¿ç”¨ã™ã‚‹ãŸã‚å®‰å…¨

## ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### "SUPABASE_SERVICE_KEY is not set" ã‚¨ãƒ©ãƒ¼

`.env.local` ã« `SUPABASE_SERVICE_KEY` ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚

### "User not found" ã‚¨ãƒ©ãƒ¼

ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒæ­£ç¢ºã«å…¥åŠ›ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚ãƒ•ãƒ«ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼ˆä¾‹: `test1@stu.teikyo-u.ac.jp`ï¼‰ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚

### ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼

Supabase ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§ä»¥ä¸‹ã‚’ç¢ºèªï¼š

1. SQL Editor ã§ã€ŒRunã€ã‚’å®Ÿè¡Œã§ãã‚‹ã‹
2. ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ç¢ºèª
3. ãƒ†ãƒ¼ãƒ–ãƒ«ãŒæ—¢ã«å­˜åœ¨ã™ã‚‹å ´åˆã¯ `DROP TABLE IF EXISTS` ã§å‰Šé™¤ã—ã¦ã‹ã‚‰å†å®Ÿè¡Œ

## æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

- ç®¡ç†ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãƒšãƒ¼ã‚¸ã®ä½œæˆ
- ç®¡ç†è€…å°‚ç”¨API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ç”»é¢ã®æ§‹ç¯‰
- ãƒ­ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹ã®ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ï¼ˆRBACï¼‰ã®å®Ÿè£…
